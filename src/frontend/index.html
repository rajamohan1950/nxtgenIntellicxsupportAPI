<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multilingual Customer Support</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        .header-section {
            flex-shrink: 0;
            padding: 10px 0;
        }
        .chat-container {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .input-section {
            flex-shrink: 0;
            margin-top: -10px;
        }
        .message {
            max-width: 80%;
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 12px;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #e3f2fd;
            margin-left: auto;
        }
        .assistant-message {
            background-color: #ffffff;
            margin-right: auto;
            border: 1px solid #e0e0e0;
        }
        .typing-indicator {
            display: inline-block;
            padding: 8px 12px;
            background-color: #f5f5f5;
            border-radius: 12px;
        }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #90a4ae;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .suggestion-btn {
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
            margin: 2px;
        }
        .suggestion-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .debug-toggle {
            cursor: pointer;
            user-select: none;
        }
        .debug-content {
            max-height: 150px;
            overflow-y: auto;
            font-size: 11px;
        }
        .debug-hidden {
            display: none;
        }
        h1 {
            margin: 0;
            font-size: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="main-container">
        <div class="bg-white rounded-lg shadow-lg p-3" style="height: 100%; display: flex; flex-direction: column;">
            <!-- Header Section -->
            <div class="header-section">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-xl font-bold text-blue-600">
                        Multilingual Customer Support
                    </h1>
                    <!-- Language Selection -->
                    <select id="languageSelect" class="p-1 text-sm border rounded bg-gray-50">
                        <option value="">Auto-detect</option>
                    </select>
                </div>
            </div>
            
            <!-- Chat Container -->
            <div class="chat-container" id="chatContainer" style="min-height: 200px;">
                <div id="chatMessages">
                    <div class="message assistant-message">
                        Loading chat interface...
                    </div>
                </div>
                <div id="typingIndicator" class="typing-indicator hidden">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            
            <!-- Input Section -->
            <div class="input-section">
                <!-- Suggestion Buttons -->
                <div id="suggestionButtons" class="mb-1 flex flex-wrap gap-1">
                    <!-- Will be populated dynamically -->
                </div>
                
                <!-- Input Form -->
                <form id="queryForm" class="flex gap-2 mb-1">
                    <input 
                        type="text" 
                        id="queryInput" 
                        class="flex-grow p-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                        placeholder="Type your message here..."
                        required
                        autocomplete="off"
                    >
                    <button 
                        type="submit" 
                        id="sendButton"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
                    >
                        Send
                    </button>
                </form>
                
                <!-- Debug Info (Collapsible) -->
                <div class="mt-1">
                    <div class="debug-toggle text-xs text-gray-500 cursor-pointer" onclick="toggleDebug()">
                        <span id="debugToggleText">â–¼</span> Debug Info
                    </div>
                    <div id="debugInfo" class="debug-hidden mt-1 p-2 bg-gray-100 rounded text-xs">
                        <pre id="debugText" class="debug-content text-xs"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global configuration
        const API_URL = 'http://localhost:8000';
        let supportedLanguages = [];
        let initialized = false;
        
        // Initialize the app
        async function init() {
            // Prevent multiple initializations
            if (initialized) {
                console.log('Already initialized, skipping...');
                return;
            }
            initialized = true;
            try {
                console.log('Initializing app...');
                console.log('API URL:', API_URL);
                
                // Test backend connection first
                const healthCheck = await fetch(`${API_URL}/health`);
                if (!healthCheck.ok) {
                    throw new Error(`Backend health check failed: ${healthCheck.status}`);
                }
                console.log('âœ… Backend is healthy');
                
                // Fetch supported languages
                const response = await fetch(`${API_URL}/supported_languages`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch languages: ${response.status}`);
                }
                supportedLanguages = await response.json();
                console.log('âœ… Supported languages:', supportedLanguages);
                
                // Populate language select
                const languageSelect = document.getElementById('languageSelect');
                if (languageSelect) {
                    supportedLanguages.forEach(lang => {
                        const option = document.createElement('option');
                        option.value = lang;
                        option.textContent = new Intl.DisplayNames(['en'], {type: 'language'}).of(lang);
                        languageSelect.appendChild(option);
                    });
                }

                // Clear loading message
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.innerHTML = '';
                }
                
                // Show initial suggestions
                showDynamicSuggestions('greeting');
                
                // Add welcome message
                addMessage("Welcome to our multilingual customer support! How can I help you today?", 'assistant');
                console.log('âœ… App initialized successfully');
            } catch (error) {
                console.error('âŒ Error initializing app:', error);
                // Show error message
                addMessage(`Error connecting to backend: ${error.message}. Please ensure the backend server is running at ${API_URL}`, 'assistant');
                updateDebugInfo({ error: error.message, stack: error.stack });
            }
        }
        
        // Handle form submission
        async function handleSubmit(e) {
            console.log('=== handleSubmit called ===');
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            const queryInput = document.getElementById('queryInput');
            const sendButton = document.getElementById('sendButton');
            
            if (!queryInput) {
                console.error('âŒ queryInput element not found!');
                return;
            }
            
            const query = queryInput.value.trim();
            
            if (!query) {
                console.log('Empty query, ignoring');
                return;
            }
            
            console.log('Form submitted with query:', query);
            console.log('Input element:', queryInput);
            console.log('Send button:', sendButton);
            
            // Disable input and button
            queryInput.disabled = true;
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            
            // Add user message to chat
            addMessage(query, 'user');
            queryInput.value = '';
            
            // Show typing indicator
            document.getElementById('typingIndicator').classList.remove('hidden');
            
            try {
                const preferredLanguage = document.getElementById('languageSelect').value;
                console.log('Sending request to:', `${API_URL}/process_query`);
                console.log('Request body:', { text: query, preferred_language: preferredLanguage || null });
                
                const response = await fetch(`${API_URL}/process_query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: query,
                        preferred_language: preferredLanguage || null
                    })
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('âœ… Response data received:', result);
                console.log('Response text:', result.response);
                
                // Hide typing indicator
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.classList.add('hidden');
                }
                
                // Add assistant message to chat
                const responseText = result.response || result.translated_response || 'No response received';
                console.log('Displaying response:', responseText);
                addMessage(responseText, 'assistant');
                
                // Update debug info
                updateDebugInfo(result);

                // Show dynamic suggestions based on intent
                showDynamicSuggestions(result.intent || 'unknown');
            } catch (error) {
                console.error('âŒ Error processing query:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                document.getElementById('typingIndicator').classList.add('hidden');
                
                let errorMsg = `Error: ${error.message}`;
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg = `Cannot connect to backend server at ${API_URL}. Please ensure the server is running.`;
                }
                
                addMessage(errorMsg, 'assistant');
                updateDebugInfo({ 
                    error: error.message, 
                    stack: error.stack,
                    name: error.name,
                    timestamp: new Date().toISOString()
                });
            } finally {
                // Re-enable input and button
                queryInput.disabled = false;
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                queryInput.focus();
            }
        }
        
        // Attach event listeners - ensure this runs after DOM is ready
        function attachEventListeners() {
            console.log('ðŸ”§ Attaching event listeners...');
            const queryForm = document.getElementById('queryForm');
            const queryInput = document.getElementById('queryInput');
            const sendButton = document.getElementById('sendButton');
            
            if (!queryForm) {
                console.error('âŒ queryForm not found!');
                return;
            }
            
            if (!queryInput) {
                console.error('âŒ queryInput not found!');
                return;
            }
            
            // Attach submit handler directly to form
            queryForm.onsubmit = function(e) {
                console.log('ðŸ“ Form onsubmit triggered');
                e.preventDefault();
                e.stopPropagation();
                handleSubmit(e);
                return false;
            };
            console.log('âœ… Form onsubmit handler attached');
            
            // Attach button click handler
            if (sendButton) {
                sendButton.onclick = function(e) {
                    console.log('ðŸ–±ï¸ Send button clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    handleSubmit(e);
                    return false;
                };
                console.log('âœ… Button onclick handler attached');
            }
            
            // Attach Enter key handler
            queryInput.onkeypress = function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    console.log('âŒ¨ï¸ Enter key pressed');
                    e.preventDefault();
                    handleSubmit(e);
                    return false;
                }
            };
            console.log('âœ… Input onkeypress handler attached');
            
            console.log('âœ… All event listeners attached successfully');
        }
        
        // Attach listeners when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('ðŸ“„ DOMContentLoaded fired');
                attachEventListeners();
            });
        } else {
            console.log('ðŸ“„ DOM already loaded');
            attachEventListeners();
        }
        
        // Add a message to the chat
        function addMessage(text, sender) {
            console.log(`ðŸ’¬ addMessage called: sender=${sender}, text="${text.substring(0, 50)}..."`);
            
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) {
                console.error('âŒ chatMessages element not found!');
                alert('Error: Chat container not found!');
                return;
            }
            
            console.log('âœ… chatMessages element found:', chatMessages);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block'; // Ensure it's visible
            messageDiv.style.margin = '5px 0'; // Add spacing
            
            chatMessages.appendChild(messageDiv);
            console.log('âœ… Message div appended to chatMessages');
            console.log('   Total messages in chat:', chatMessages.children.length);
            
            // Force a reflow to ensure the message is rendered
            void messageDiv.offsetHeight;
            
            // Scroll to bottom
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
                console.log('âœ… Scrolled to bottom');
            } else {
                console.warn('âš ï¸ chatContainer not found for scrolling');
            }
            
            console.log('âœ… Message added successfully');
        }
        
        // Update debug information
        function updateDebugInfo(result) {
            const debugText = document.getElementById('debugText');
            debugText.textContent = JSON.stringify(result, null, 2);
        }
        
        // Toggle debug info
        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            const toggleText = document.getElementById('debugToggleText');
            if (debugInfo.classList.contains('debug-hidden')) {
                debugInfo.classList.remove('debug-hidden');
                toggleText.textContent = 'â–²';
            } else {
                debugInfo.classList.add('debug-hidden');
                toggleText.textContent = 'â–¼';
            }
        }
        
        // Show dynamic suggestions based on intent
        function showDynamicSuggestions(intent) {
            const dynamicSuggestions = {
                'greeting': [
                    'How are you?',
                    'I need help with something',
                    'What services do you offer?',
                    'Tell me about your pricing'
                ],
                'farewell': [
                    'Wait, I have another question',
                    'Thank you for your help',
                    'How can I contact support?',
                    'Start a new conversation'
                ],
                'help': [
                    'I need technical support',
                    'How do I contact customer service?',
                    'What are your prices?',
                    'Can you explain how this works?'
                ],
                'product_info': [
                    'What are your prices?',
                    'Do you offer free trials?',
                    'How does your product compare to others?',
                    'How can I contact sales?'
                ],
                'pricing': [
                    'Tell me about the basic plan',
                    'What features come with premium?',
                    'Do you offer discounts?',
                    'Is there a free trial?'
                ],
                'contact': [
                    'What are your support hours?',
                    'Do you have live chat?',
                    'I need technical help',
                    'Can I speak to a manager?'
                ],
                'technical_support': [
                    'My app is crashing',
                    "I'm getting an error message",
                    'How do I reset my password?',
                    'The system is very slow'
                ],
                'unknown': [
                    'Let me try again',
                    'I need help with something else',
                    'Can you tell me about your company?',
                    'What services do you offer?'
                ]
            };
            
            // Get suggestions for the current intent
            const suggestions = dynamicSuggestions[intent] || dynamicSuggestions['unknown'];
            
            // Clear existing dynamic suggestions
            const suggestionButtons = document.getElementById('suggestionButtons');
            suggestionButtons.innerHTML = '';
            
            // Add all suggestions
            suggestions.forEach(suggestion => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'suggestion-btn bg-gray-200 px-2 py-1 rounded-lg hover:bg-gray-300 transition-colors text-xs';
                button.textContent = suggestion;
                button.addEventListener('click', function() {
                    const queryInput = document.getElementById('queryInput');
                    queryInput.value = this.textContent;
                    const form = document.getElementById('queryForm');
                    if (form) {
                        form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                    }
                });
                suggestionButtons.appendChild(button);
            });
        }
        
        // Initialize the app when DOM is ready
        // Use a single initialization to avoid duplicates
        (function() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                // DOM already loaded
                init();
            }
        })();
    </script>
</body>
</html> 